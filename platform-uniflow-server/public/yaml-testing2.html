<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YAML testing</title>
    <script src="js/js-yaml-dist.js"></script>
</head>
<body>
<p id="content"></p>
<script>
    (function () {
            function spliceSlice(str, index, count, add) {
                // We cannot pass negative indexes dirrectly to the 2nd slicing operation.
                if (index < 0) {
                    index = str.length + index;
                    if (index < 0) {
                        index = 0;
                    }
                }

                return str.slice(0, index) + (add || "") + str.slice(index + count);
            }

            function repeat(string, count) {
                var result = '', cycle;

                for (cycle = 0; cycle < count; cycle += 1) {
                    result += string;
                }

                return result;
            }

            function indentString(string, spaces) {
                var ind = repeat(' ', spaces),
                    position = 0,
                    next = -1,
                    result = '',
                    line,
                    length = string.length;

                while (position < length) {
                    next = string.indexOf('\n', position);
                    if (next === -1) {
                        line = string.slice(position);
                        position = length;
                    } else {
                        line = string.slice(position, next + 1);
                        position = next + 1;
                    }

                    if (line.length && line !== '\n') result += ind;

                    result += line;
                }

                return result;
            }

            function readTxt(input, fromPosition, toPosition) {
                var txt = ''
                for (var i = fromPosition; i < toPosition; i++) txt += input[i]

                return txt;
            }

            function endLinePosition(input, position) {
                var ch = input.charCodeAt(position);
                while (ch !== 0x0A/* LF */ && ch !== 0x0D/* CR */ && ch !== 0) {
                    ch = input.charCodeAt(++position);
                }

                return position
            }

            yamlAdd = function (key, value, yaml) {
                let nodeStack = [], storeStack = {}, indentationSpaceAdverage = [2];

                let listenerFunction = function (mode, state) {
                    if (mode === 'open') {
                        nodeStack.push({
                            position: state.position
                        })
                    } else {
                        let item = nodeStack.pop(),
                            stack = nodeStack.length,
                            node = {
                                from: item.position,
                                to: state.position,
                                lineIndent: state.lineIndent,
                            }

                        if (storeStack[stack] === undefined) {
                            storeStack[stack] = []
                        }
                        storeStack[stack].push(node)

                        if (state.kind === 'scalar') {
                            /*console.log({
                                stack: stack,
                                tag: state.tag,
                                word: state.result,
                                from: node.from,
                                to: node.to,
                                txt: readTxt(state.input, node.from, node.to),
                            })*/

                            node.value = state.result
                        } else {
                            node.to = node.from
                            Object.keys(storeStack).forEach(function (s) {
                                storeStack[s].forEach(function (store) {
                                    node.to = Math.max(node.to, store.to)
                                })

                                //we don't need upper stack, just mapping
                                if (s > stack + 1) {
                                    delete storeStack[s]
                                }
                            })
                            node.to = endLinePosition(yaml, node.to)

                            if (state.tag === null && state.kind === 'mapping') {
                                node.children = {}

                                for (let index = 0; index < storeStack[stack + 1].length; index += 2) {
                                    let keyNode = storeStack[stack + 1][index]
                                    let valueNode = storeStack[stack + 1][index + 1]

                                    node.children[keyNode.value] = {
                                        key: keyNode,
                                        value: valueNode,
                                    }

                                    if(stack > 0) {
                                        indentationSpaceAdverage.push(keyNode.lineIndent / stack)
                                    }
                                }
                                delete storeStack[stack + 1]

                                /*console.log({
                                    stack: stack,
                                    tag: state.tag,
                                    lineIdent: state.lineIndent,
                                    kind: state.kind,
                                    from: node.from,
                                    to: node.to,
                                    txt: readTxt(state.input, node.from, node.to),
                                })*/
                            }
                        }
                    }
                }

                jsyaml.load(yaml, {
                    'listener': listenerFunction
                })

                let root = storeStack[0][0],
                    indentationSpace = Math.round(indentationSpaceAdverage.reduce(function (count, spaces) {
                        return count + spaces;
                    }, 0) / indentationSpaceAdverage.length)

                let keys = key.split('.'), keyIndex;
                for (keyIndex = 0; keyIndex < keys.length; keyIndex++) {
                    if (root.children === undefined) {
                        return yaml //can't add to non mapping
                    }

                    let keyValue = keys[keyIndex]
                    if (root.children[keyValue] === undefined) {
                        break;
                    }

                    root = root.children[keyValue].value
                }

                if (keyIndex === keys.length) {
                    // replace mapping value
                    yaml = spliceSlice(yaml, root.from, root.to - root.from, ' ' + value)
                } else if(root.children !== undefined) {
                    // add mapping value to the end of this mapping
                    let obj = value, keyIndex2
                    for (keyIndex2 = keys.length - 1; keyIndex2 >= keyIndex; keyIndex2--) {
                        let newObj = {}
                        newObj[keys[keyIndex2]] = obj
                        obj = Object.assign({}, newObj)
                    }

                    // calculate indentation for the mapping
                    let indentation, childsKeys = Object.keys(root.children);
                    if(childsKeys.length > 0) {
                        indentation = root.children[childsKeys[0]].key.lineIndent
                    } else {
                        indentation = keyIndex * indentationSpace
                    }

                    let add = jsyaml.dump(obj, {indent: indentationSpace})
                    add = '\n' + add.slice(0, add.length - 1) //remove end line and add it to begin
                    add = indentString(add, indentation)
                    yaml = spliceSlice(yaml, root.to, 0, add)
                }

                return yaml
            }

            var newYaml = yamlAdd('config.labels.toto.coco', 'toutou', `---
# Collection Types #############################################################
################################################################################

# http://yaml.org/type/map.html -----------------------------------------------#

map:
  # Unordered set of key: value pairs.
  Block style: !!map
    Clark : Evans
    Ingy  : döt Net
    Oren  : Ben-Kiki
  Flow style: !!map { Clark: Evans, Ingy: döt Net, Oren: Ben-Kiki }



config.back.value:
  preview: preview # toto


config:
  labels:
    updated: updated at
    #coco
  ui:
    saved: config saved # toto

large sequence:
  - seq large1:
      - key1
      - key2
      - key3
  # comment into sequence
  - seq large2:
      - skey1
      - skey2
      - skey3

# http://yaml.org/type/omap.html ----------------------------------------------#

omap:
  # Explicitly typed ordered map (dictionary).
  Bestiary: !!omap
    - aardvark: African pig-like ant eater. Ugly.
    - anteater: South-American ant eater. Two species.
    - anaconda: South-American constrictor snake. Scaly.
    # Etc.
  # Flow style
  Numbers: !!omap [ one: 1, two: 2, three : 3 ]

# http://yaml.org/type/pairs.html ---------------------------------------------#

pairs:
  # Explicitly typed pairs.
  Block tasks: !!pairs
    - meeting: with team.
    - meeting: with boss.
    - break: lunch.
    - meeting: with client.
  Flow tasks: !!pairs [ meeting: with team, meeting: with boss ]

# http://yaml.org/type/set.html -----------------------------------------------#

set:
  # Explicitly typed set.
  baseball players: !!set
    ? Mark McGwire
    ? Sammy Sosa
    ? Ken Griffey
  # Flow style
  baseball teams: !!set { Boston Red Sox, Detroit Tigers, New York Yankees }

# http://yaml.org/type/seq.html -----------------------------------------------#

seq:
  # Ordered sequence of nodes
  Block style: !!seq
  - Mercury   # Rotates - no light/dark sides.
  - Venus     # Deadliest. Aptly named.
  - Earth     # Mostly dirt.
  - Mars      # Seems empty.
  - Jupiter   # The king.
  - Saturn    # Pretty.
  - Uranus    # Where the sun hardly shines.
  - Neptune   # Boring. No rings.
  - Pluto     # You call this a planet?
  Flow style: !!seq [ Mercury, Venus, Earth, Mars,      # Rocks
                      Jupiter, Saturn, Uranus, Neptune, # Gas
                      Pluto ]                           # Overrated


# Scalar Types #################################################################
################################################################################

# http://yaml.org/type/binary.html --------------------------------------------#

binary:
  canonical: !!binary "\\
    R0lGODlhDAAMAIQAAP//9/X17unp5WZmZgAAAOfn515eXvPz7Y6OjuDg4J+fn5\\
    OTk6enp56enmlpaWNjY6Ojo4SEhP/++f/++f/++f/++f/++f/++f/++f/++f/+\\
    +f/++f/++f/++f/++f/++SH+Dk1hZGUgd2l0aCBHSU1QACwAAAAADAAMAAAFLC\\
    AgjoEwnuNAFOhpEMTRiggcz4BNJHrv/zCFcLiwMWYNG84BwwEeECcgggoBADs="
  generic: !!binary |
    R0lGODlhDAAMAIQAAP//9/X17unp5WZmZgAAAOfn515eXvPz7Y6OjuDg4J+fn5
    OTk6enp56enmlpaWNjY6Ojo4SEhP/++f/++f/++f/++f/++f/++f/++f/++f/+
    +f/++f/++f/++f/++f/++SH+Dk1hZGUgd2l0aCBHSU1QACwAAAAADAAMAAAFLC
    AgjoEwnuNAFOhpEMTRiggcz4BNJHrv/zCFcLiwMWYNG84BwwEeECcgggoBADs=
  description:
    The binary value above is a tiny arrow encoded as a gif image.

# http://yaml.org/type/bool.html ----------------------------------------------#

bool:
  - true
  - True
  - TRUE
  - false
  - False
  - FALSE

# http://yaml.org/type/float.html ---------------------------------------------#

"string sentence":
  my string: string

float:
  canonical: 6.8523015e+5
  exponential: 685.230_15e+03
  fixed: 685_230.15
  sexagesimal: 190:20:30.15
  negative infinity: -.inf
  not a number: .NaN

# http://yaml.org/type/int.html -----------------------------------------------#

int:
  canonical: 685230
  decimal: +685_230
  octal: 02472256
  hexadecimal: 0x_0A_74_AE
  binary: 0b1010_0111_0100_1010_1110
  sexagesimal: 190:20:30

# http://yaml.org/type/merge.html ---------------------------------------------#

merge:
  - &CENTER { x: 1, y: 2 }
  - &LEFT { x: 0, y: 2 }
  - &BIG { r: 10 }
  - &SMALL { r: 1 }

  # All the following maps are equal:

  - # Explicit keys
    x: 1
    y: 2
    r: 10
    label: nothing

  - # Merge one map
    << : *CENTER
    r: 10
    label: center

  - # Merge multiple maps
    << : [ *CENTER, *BIG ]
    label: center/big

  - # Override
    << : [ *BIG, *LEFT, *SMALL ]
    x: 1
    label: big/left/small

# http://yaml.org/type/null.html ----------------------------------------------#

null:
  # This mapping has four keys,
  # one has a value.
  empty:
  canonical: ~
  english: null
  ~: null key
  # This sequence has five
  # entries, two have values.
  sparse:
    - ~
    - 2nd entry
    -
    - 4th entry
    - Null

# http://yaml.org/type/str.html -----------------------------------------------#

string: abcd

# http://yaml.org/type/timestamp.html -----------------------------------------#

timestamp:
  canonical:        2001-12-15T02:59:43.1Z
  valid iso8601:    2001-12-14t21:59:43.10-05:00
  space separated:  2001-12-14 21:59:43.10 -5
  no time zone (Z): 2001-12-15 2:59:43.10
  date (00:00:00Z): 2002-12-14


# JavaScript Specific Types ####################################################
################################################################################

# https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/RegExp

regexp:
  simple: !!js/regexp      foobar
  modifiers: !!js/regexp   /foobar/mi

# https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/undefined

undefined: !!js/undefined ~

# https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function
`);

            console.log(newYaml)
        }
    )()
</script>
</body>
</html>